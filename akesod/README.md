# akesod

Akeso daemon to run secure cloud services

Steps to run:
- Generate a config for group members
  ```bash
  echo -e "akesod  keys/akesod-ik-pub.pem   keys/akesod-ek-pub.pem\nbob     keys/bob-ik-pub.pem      keys/bob-ek-pub.pem\ncici    keys/cici-ik-pub.pem     keys/cici-ek-pub.pem\ndave    keys/dave-ik-pub.pem     keys/dave-ek-pub.pem" > keys/4.conf
  ```
  
- Copy config.yaml.example to config.yaml and configure the values. 

    ```bash
    cp config/config.yaml.example config/config.yaml
    ```

- For intializing keys and setting up group, run
    - Make sure the config has setupRequired set as 'true'
    - Make sure the necessary pub/sub topics are created
    ```bash
        #Create a GroupSetup Pub/Sub Channel
        gcloud pubsub topics create GroupSetup
        # Create a KeyUpdate Pub/Sub Channel
        gcloud pubsub topics create KeyUpdate
    ```
    - Run make and then run the binary
    ```bash
    make
    ./akesod
    ```

- On update msg received, download and upload with new key can be tested by
  - First use cloud-cp to keep a encrypted object in the bucket with AES key generated by initial stage key
  - Run akesod as `./akesod`
  - Publish any message to KeyUpdate channel

- For CMEK, the following steps are necessary
  
```bash
# Enable CloudKMS
gcloud services enable cloudkms.googleapis.com cloudtasks.googleapis.com --project=$PROJECT_ID

# Create keyring
gcloud kms keyrings create akeso_dev --location us-east1

# Listing keys in keyring
gcloud kms keys list --keyring=akeso_dev --location=us-east1 --project=$PROJECT_ID

# Create Keys
gcloud kms keys create key1 \
    --keyring akeso_dev \
    --location us-east1 \
    --purpose "encryption" \
    --protection-level "software"

gcloud kms keys create key2 \
    --keyring akeso_dev \
    --location us-east1 \
    --purpose "encryption" \
    --protection-level "hsm"

# Find Project Number
export PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)" | tail -1)

# Grant Permission to the service account
gcloud kms keys add-iam-policy-binding key1 \
  --location us-east1 \
  --keyring akeso_dev \
  --member serviceAccount:service-$PROJECT_NUMBER@gs-project-accounts.iam.gserviceaccount.com \
  --role roles/cloudkms.cryptoKeyEncrypterDecrypter

gcloud kms keys add-iam-policy-binding key2 \
  --location us-east1 \
  --keyring akeso_dev \
  --member serviceAccount:service-$PROJECT_NUMBER@gs-project-accounts.iam.gserviceaccount.com \
  --role roles/cloudkms.cryptoKeyEncrypterDecrypter
```

- For Akeso, the following steps are necessary
```bash
# Create a MetadataUpdate Pub/Sub Channel
gcloud pubsub topics create MetadataUpdate

# Start the Serverless function
# First ensure `roles/pubsub.publisher` [role is assigned to the service agent](https://cloud.google.com/storage/docs/reporting-changes#grant-required-role-to-service-agent) in your project. Assign the role using: 
 
export PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)" | tail -1)
gcloud projects add-iam-policy-binding $PROJECT_ID --member=serviceAccount:service-${PROJECT_NUMBER}@gs-project-accounts.iam.gserviceaccount.com --role=roles/pubsub.publisher


# First setup a notification config in cloud storage bucket. This sends the object's metadata update event (pub/sub message) to the given topic id. The key for encrypting object is attached within the event's custom attribute.
#Example:

./gcs-utils -notification-config -topic-id MetadataUpdate -project-id $PROJECT_ID -event-type OBJECT_METADATA_UPDATE -custom-attributes=new_dek=x++yudvAtO9scc4NPYQusmPD0bsiyQic9ZHziqu62DE= gs://<BUCKET>
  

#Next setup a cloud function that receives the event (pub/sub message) and encrypts the object.

gcloud functions deploy encrypt-object \
  --gen2 \
  --runtime=go122 \
  --region=us-east1 \
  --source=./cmd/gcs-utils/cloud-functions/encrypt-object/ \
  --entry-point=EncryptObject \
  --trigger-topic=MetadataUpdate \
  --memory=512MB \
  --cpu=0.5

